<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>web-devfs (pntr)</title>
  <script type="importmap">
    {
      "imports": {
        "web-zen-dev": "../web-devfs.js",
        "easywasi": "https://esm.sh/easywasi",
        "@zenfs/core": "https://esm.sh/@zenfs/core",
        "@zenfs/dom": "https://esm.sh/@zenfs/dom"
      }
    }
  </script>
  <link rel="stylesheet" href="../demo.css">
</head>
<body>

<p>
This is a simple demo that uses <a href="https://github.com/robloach/pntr">pntr</a> to draw on the framebuffer.
</p>

<canvas id="fb" width=640 height=480 />

<script type="module">
import { configure, InMemory, fs } from '@zenfs/core'
import { IndexedDB } from '@zenfs/dom'
import { WasiPreview1 } from 'easywasi'
import WebDevFS from 'web-zen-dev'

await configure({ addDevices: true })
const canvas = document.getElementById('fb')
const wd = new WebDevFS()
fs.mounts.get('/dev').createDevice('/fb0', wd.framebuffer(canvas))

const wasi_snapshot_preview1 = new WasiPreview1()
const {instance: { exports }} = await WebAssembly.instantiateStreaming(fetch('test.wasm'), {
  wasi_snapshot_preview1
})
wasi_snapshot_preview1.start(exports)

function updateScreen() {
  const sp = exports.update()
  const screen = new Uint8Array(exports.memory.buffer).slice(sp, sp + (640 * 480 * 4))
  fs.writeFileSync('/dev/fb0', screen)
  requestAnimationFrame(updateScreen)
}
updateScreen()

</script>
</body>
</html>

