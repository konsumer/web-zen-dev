<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>web-devfs</title>
	<script type="importmap">
    {
      "imports": {
      	"web-zen-dev": "./web-devfs.js",
        "@zenfs/core": "https://esm.sh/@zenfs/core",
        "@zenfs/dom": "https://esm.sh/@zenfs/dom"
      }
    }
  </script>
  <style type="text/css">
  	html, body {
  		height: 100vh;
  		margin: 0;
  		display:flex;
  		align-items: center;
  		background: black;
  	}
  	canvas {
  		width: 100vw;
  	}
  </style>
</head>
<body>

<script type="module">
import { configure, InMemory, fs } from '@zenfs/core'
import { IndexedDB } from '@zenfs/dom'
import WebDevFS from 'web-zen-dev'

await configure({
	mounts: {
		'/tmp': InMemory,
		'/home': IndexedDB,
	},
	addDevices: true
})

// TODO: work on a full backend-driver to make setup simpler
const wd = new WebDevFS()
fs.mounts.get('/dev').createDevice('/fb0', wd.framebuffer())
fs.mounts.get('/dev').createDevice('/dsp', wd.dsp())

// example: write static to framebuffer
const screen = new Uint8Array(wd.canvas.width*wd.canvas.height*4)
function makestaticFb() {
	for (let i=0; i<screen.byteLength;i+=4) {
		screen[i] = Math.random() * 255
		screen[i+1] = Math.random() * 255
		screen[i+2] = Math.random() * 255
		screen[i+3] = 255
	}
	fs.promises.writeFile('/dev/fb0', screen)
	requestAnimationFrame(makestaticFb)
}
makestaticFb()

// example: write static to audio
// TODO: not working right
// const audioFrame = new Uint8Array(48000)
// const audioView = new DataView(audioFrame.buffer)
// function makestaticDsp() {
// 	for (let i=0; i<audioFrame.byteLength;i+=4) {
// 		audioView.setFloat32(i, Math.random() * 2 - 1) 
// 	}
// 	fs.promises.writeFile('/dev/dsp', audioFrame)
// 	requestAnimationFrame(makestaticDsp)
// }
// makestaticDsp()

</script>
</body>
</html>

